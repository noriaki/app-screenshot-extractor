# Implementation Plan

## 実装タスク一覧

- [ ] 1. プロンプトテンプレート管理機能の実装
  - 外部ファイルからプロンプトテンプレートを読み込む機能を実装する
  - 音声あり用・音声なし用の2種類のテンプレートを管理する
  - テンプレートが存在しない場合はデフォルトテンプレートを使用する
  - str.format()による変数置換機能を実装する
  - 必須変数（app_name、total_screenshots）の検証を行う
  - _Requirements: 2.1-2.6, 6.1, 6.2, 6.4_

- [ ] 2. 画像データ準備とbase64エンコード機能の実装
  - スクリーンショット画像ファイルを読み込む機能を実装する
  - 画像をbase64形式にエンコードする処理を実装する
  - Claude API仕様に準拠したリクエスト形式（type: image、source.type: base64）に変換する
  - 画像サイズ制限（3.75MB、8000px）の検証を実装する
  - 最大20枚までの画像制限を検証する
  - _Requirements: 1.1, 1.2_

- [ ] 3. 入力データ検証機能の実装
  - スクリーンショット画像ファイルの存在確認を行う
  - メタデータJSONファイル（metadata.json）の読み込みと検証を実装する
  - 音声文字起こしデータ（transcript.json）の存在確認と読み込みを実装する
  - 入力データが不正または欠損している場合のエラー処理を実装する
  - _Requirements: 1.5, 5.2, 5.3_

- [ ] 4. Claude API統合とリトライ機能の実装
- [ ] 4.1 Claude API呼び出し機能の実装
  - anthropic Python SDKを使用してClaude APIに接続する
  - Messages API（messages.create）を使用してリクエストを送信する
  - 環境変数ANTHROPIC_API_KEYからAPIキーを取得する
  - 画像データとプロンプトテキストを含むcontent blocksを構築する
  - APIレスポンスから生成された記事テキストを抽出する
  - _Requirements: 1.4, 5.5_

- [ ] 4.2 エラーハンドリングとリトライ戦略の実装
  - 429レート制限エラーに対するリトライ処理を実装する（最大3回）
  - 529サーバー過負荷エラーに対するリトライ処理を実装する（最大3回）
  - retry-afterヘッダーの優先とフォールバック（3秒待機）を実装する
  - 401認証エラー時は即座にエラー終了する処理を実装する
  - その他のAPIエラー（4xx、5xx）の詳細なログ出力を実装する
  - _Requirements: 5.1, 5.4_

- [ ] 5. 記事品質検証機能の実装
  - 生成されたMarkdownの構造検証（H1、H2、画像リンク）を実装する
  - 最低文字数（500文字以上）の検証を実装する
  - 画像リンクの存在確認（実在するファイルパス）を実装する
  - 品質検証に失敗した場合の警告メッセージ生成を実装する
  - 品質メトリクス（文字数、見出し数、画像数）の計測を実装する
  - _Requirements: 7.1, 7.2, 7.3, 7.5_

- [ ] 6. 記事生成メタデータ管理機能の実装
  - 生成日時、使用モデル、プロンプトバージョンの記録を実装する
  - API使用状況（input_tokens、output_tokens、コスト）の記録を実装する
  - 品質検証結果（valid、warnings、metrics）の記録を実装する
  - メタデータをJSON形式（ai_metadata.json）で保存する機能を実装する
  - _Requirements: 7.4_

- [ ] 7. AIContentGeneratorクラスの統合実装
  - PromptTemplateManager、QualityValidatorを統合する
  - synchronized_dataから画像パスと音声文字起こしを抽出する
  - 音声の有無に応じて適切なプロンプトテンプレートを選択する
  - API呼び出しから記事保存までの全体フローを実装する
  - エラー発生時の安全な処理中断とロールバックを実装する
  - _Requirements: 3.1-3.6_

- [ ] 8. 既存パイプラインへのCLI統合
  - コマンドライン引数パーサーに--ai-articleオプションを追加する
  - --app-nameオプションを追加し、未指定時は動画ファイル名から推測する
  - --ai-modelオプションを追加し、Claudeモデル選択を可能にする
  - --output-formatオプションを追加し、markdown/html選択を可能にする
  - run_integration_flow()関数にAI記事生成処理を統合する
  - _Requirements: 4.1, 4.2, 6.3, 6.5_

- [ ] 9. 出力ファイル保存機能の実装
  - 生成された記事をai_article.mdとして指定ディレクトリに保存する
  - 既存の命名規則（article.md）と区別する
  - 品質警告がある場合でも記事を保存し、警告を表示する
  - 保存成功時の確認メッセージをCLIに表示する
  - _Requirements: 4.3, 4.4_

- [ ] 10. プロンプトテンプレートファイルの作成
  - prompts/article_with_audio.txtテンプレートを作成する
  - prompts/article_without_audio.txtテンプレートを作成する
  - 役割定義、分析指示、文体指示、出力形式を含める
  - 変数プレースホルダー（{app_name}、{total_screenshots}）を配置する
  - _Requirements: 2.1-2.5_

- [ ] 11. ユニットテストの実装
- [ ] 11.1 AIContentGeneratorのテスト実装
  - 正常な入力データの検証成功を確認するテストを作成する
  - スクリーンショット0枚時のエラー処理を確認するテストを作成する
  - 画像base64変換の正常動作を確認するテストを作成する
  - 画像サイズ超過時のエラー処理を確認するテストを作成する
  - API呼び出し成功時のレスポンス処理を確認するテストを作成する
  - レート制限エラー時のリトライ動作を確認するテストを作成する（モック使用）
  - リトライ上限到達時の例外処理を確認するテストを作成する
  - 記事とメタデータの正常保存を確認するテストを作成する
  - _Requirements: All requirements - AIContentGenerator validation_

- [ ] 11.2 PromptTemplateManagerのテスト実装
  - article_with_audio.txtの読み込み成功を確認するテストを作成する
  - article_without_audio.txtの読み込み成功を確認するテストを作成する
  - ファイル不存在時のデフォルト使用を確認するテストを作成する
  - str.format()による変数置換の正常動作を確認するテストを作成する
  - 必須変数欠落時のエラー処理を確認するテストを作成する
  - 音声あり用デフォルトテンプレートの内容を確認するテストを作成する
  - 音声なし用デフォルトテンプレートの内容を確認するテストを作成する
  - _Requirements: All requirements - PromptTemplateManager validation_

- [ ] 11.3 QualityValidatorのテスト実装
  - 全検証項目合格時の結果を確認するテストを作成する
  - 文字数不足時の警告を確認するテストを作成する
  - 正常なMarkdown構造の検証成功を確認するテストを作成する
  - H1見出し欠如時の検証失敗を確認するテストを作成する
  - 全画像リンク有効時の検証を確認するテストを作成する
  - 壊れたリンク検出を確認するテストを作成する
  - _Requirements: All requirements - QualityValidator validation_

- [ ] 12. 統合テストの実装
  - 音声あり・AI記事生成の完全フローを確認するテストを作成する（モック使用）
  - 音声なし・AI記事生成の完全フローを確認するテストを作成する
  - 既存Markdown生成とAI記事生成の同時実行を確認するテストを作成する
  - APIエラー時に既存機能が影響を受けないことを確認するテストを作成する
  - 新規コマンドライン引数の解析を確認するテストを作成する
  - 動画ファイル名からアプリ名を正しく抽出できることを確認するテストを作成する
  - ファイル名が無効な場合にデフォルト値を使用することを確認するテストを作成する
  - --app-nameオプションが動画ファイル名より優先されることを確認するテストを作成する
  - _Requirements: 4.1-4.5 - Integration validation_

- [ ] 13. エンドツーエンドテストの実装
  - スクリーンショット抽出から音声認識、AI記事生成までの完全パイプラインを確認するテストを作成する
  - 品質警告付き記事の保存と確認を行うテストを作成する
  - カスタムプロンプトテンプレート使用を確認するテストを作成する
  - APIキー未設定時のエラーメッセージを確認するテストを作成する
  - _Requirements: All requirements - E2E validation_

- [ ] 14. 依存ライブラリの追加と環境設定
  - requirements.txtにanthropic (v0.34.0+)を追加する
  - .env.exampleファイルを作成し、ANTHROPIC_API_KEYのテンプレートを提供する
  - .gitignoreに.envファイルを追加し、APIキーの誤コミットを防止する
  - README.mdに環境変数設定手順を追加する
  - _Requirements: 5.5_

- [ ] 15. ドキュメント更新
  - README.mdに--ai-articleオプションの使用方法を追加する
  - README.mdにプロンプトテンプレートのカスタマイズ方法を追加する
  - README.mdにAI記事生成機能の概要と利用シーンを追加する
  - 出力ファイル（ai_article.md、ai_metadata.json）の説明を追加する
  - _Requirements: 全体的な利用可能性向上_
